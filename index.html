<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Simple Notepad</title>
<link rel="icon" href="data:,">
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 0 auto;
    padding: 1rem;
    max-width: 60ch;
  }
  textarea {
    width: 100%;
    min-height: 70vh;
    font-size: clamp(1rem, 2.5vw, 1.125rem);
    box-sizing: border-box;
  }
  h1 { text-align: center; }
  #status { font-size: 0.875rem; color: #555; margin-top: 5px; }
  #syncStatus { font-size: 0.875rem; margin-top: 5px; display: flex; align-items: center; gap: 0.5em; }
  #syncIndicator { width: 0.75em; height: 0.75em; border-radius: 50%; background: red; display: inline-block; }
  #bulletBtn {
    margin: 0.5em 0;
    display: block;
    width: 2em;
    height: 2em;
    font-size: 1.25rem;
    line-height: 2em;
    text-align: center;
    background: #f0f0f0;
    border: 1px solid #ccc;
    border-radius: 4px;
    padding: 0;
    cursor: pointer;
  }
  @media (min-width: 600px) {
    body { max-width: 800px; }
    textarea { min-height: 80vh; }
  }
</style>
</head>
<body>
<h1>Simple Notepad</h1>
<button id="bulletBtn" type="button" aria-label="Add bullet">&bull;</button>
<textarea id="note" placeholder="Start typing..."></textarea>
<div id="syncStatus"><span id="syncIndicator"></span><span id="syncTime"></span></div>
<div id="status"></div>
<script>
const textarea = document.getElementById('note');
const status = document.getElementById('status');
const syncIndicator = document.getElementById('syncIndicator');
const syncTime = document.getElementById('syncTime');
const LAST_SYNC_KEY = 'last-sync-time';
const STORAGE_KEY = 'notepad-content';
// URL of the sync server. Change this if you host the server elsewhere.
const SERVER_URL = 'https://testing-39z9.onrender.com';

function loadLocal() {
  textarea.value = localStorage.getItem(STORAGE_KEY) || '';
}

function loadLastSync() {
  const t = localStorage.getItem(LAST_SYNC_KEY);
  if (t) {
    const date = new Date(t);
    syncTime.textContent = `Last sync: ${date.toLocaleString()}`;
    syncIndicator.style.background = 'green';
  }
}

function setSync(success) {
  const now = new Date();
  if (success) {
    syncIndicator.style.background = 'green';
    syncTime.textContent = `Last sync: ${now.toLocaleString()}`;
    localStorage.setItem(LAST_SYNC_KEY, now.toISOString());
  } else {
    syncIndicator.style.background = 'red';
    syncTime.textContent = `Sync failed: ${now.toLocaleString()}`;
  }
}

function toggleBullet() {
  const start = textarea.selectionStart;
  const end = textarea.selectionEnd;
  const text = textarea.value;

  let lineStart = text.lastIndexOf('\n', start - 1) + 1;
  let lineEnd = text.indexOf('\n', end);
  if (lineEnd === -1) lineEnd = text.length;

  const before = text.slice(0, lineStart);
  const after = text.slice(lineEnd);
  const lines = text.slice(lineStart, lineEnd).split('\n');
  const bullet = 'â€¢ ';
  const toggled = lines
    .map(l => l.startsWith(bullet) ? l.slice(bullet.length) : bullet + l)
    .join('\n');

  textarea.value = before + toggled + after;
  textarea.selectionStart = lineStart;
  textarea.selectionEnd = lineStart + toggled.length;
  save();
}

function load() {
  loadLocal();
  loadLastSync();
  fetch(`${SERVER_URL}/notes`)
    .then(r => r.ok ? r.text() : '')
    .then(text => {
      if (text) {
        textarea.value = text;
        localStorage.setItem(STORAGE_KEY, text);
      }
      setSync(true);
    })
    .catch(() => {
      status.textContent = 'Unable to reach server';
      setSync(false);
    });
}

function save() {
  const content = textarea.value;
  localStorage.setItem(STORAGE_KEY, content);
  fetch(`${SERVER_URL}/notes`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ content })
  })
    .then(r => {
      if (r.ok) setSync(true); else setSync(false);
    })
    .catch(() => {
      status.textContent = 'Unable to reach server';
      setSync(false);
    });
  status.textContent = 'Saved';
  setTimeout(() => {
    if (status.textContent === 'Saved') status.textContent = '';
  }, 1000);
}

textarea.addEventListener('input', save);
document.getElementById('bulletBtn').addEventListener('click', toggleBullet);

load();
</script>
</body>
</html>
